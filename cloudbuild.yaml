# Cloud Build configuration para despliegue seguro
steps:
  # Paso 1: Autenticar con Google Cloud
  - name: 'gcr.io/cloud-builders/gcloud'
    args: ['auth', 'configure-docker']

  # Paso 2: Obtener secretos de Secret Manager
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'get-secrets'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Obteniendo secretos de Secret Manager..."
        gcloud secrets versions access latest --secret="api-url" > /workspace/api_url.txt
        gcloud secrets versions access latest --secret="gcp-key" > /workspace/gcp_key.txt
        gcloud secrets versions access latest --secret="app-version" > /workspace/app_version.txt

  # Paso 3: Construir la imagen
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-t', 'gcr.io/$PROJECT_ID/mani-app:$BUILD_ID',
      '-t', 'gcr.io/$PROJECT_ID/mani-app:latest',
      '.'
    ]

  # Paso 4: Subir la imagen al Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/mani-app:latest']

  # Paso 5: Desplegar a Cloud Run con variables de entorno desde secretos
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        API_URL=$(cat /workspace/api_url.txt)
        GCP_KEY=$(cat /workspace/gcp_key.txt)
        VERSION=$(cat /workspace/app_version.txt)

        gcloud run deploy mani-app \
          --image gcr.io/$PROJECT_ID/mani-app:latest \
          --region us-central1 \
          --platform managed \
          --allow-unauthenticated \
          --set-env-vars "NG_APP_API_URL=$$API_URL,NG_APP_GCP_KEY=$$GCP_KEY,NG_APP_VERSION=$$VERSION,GOOGLE_CLOUD_PROJECT=$PROJECT_ID"
    ]

# Configuración de substituciones
substitutions:
  _REGION: 'us-central1'
  _SERVICE_NAME: 'mani-app'

# Configuración de timeout
timeout: '1200s'

# Imágenes a generar
images:
  - 'gcr.io/$PROJECT_ID/mani-app:latest'

# Opciones adicionales
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
